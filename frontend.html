import streamlit as st
from PIL import Image
from api import process_image, process_video
import os
import streamlit.components.v1 as components

# Page configuration
st.set_page_config(
    page_title="Deepfake Detector",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# Hide Streamlit defaults
st.markdown("""
<style>
    #MainMenu {visibility: hidden;}
    footer {visibility: hidden;}
    header {visibility: hidden;}
    .main .block-container {
        padding: 0 !important;
        max-width: 100% !important;
    }
    .stApp {
        background: transparent !important;
    }
    iframe {
        border: none !important;
    }
</style>
""", unsafe_allow_html=True)

# Initialize session state
if 'page' not in st.session_state:
    st.session_state.page = 'hero'
if 'file_type' not in st.session_state:
    st.session_state.file_type = 'Image'
if 'uploaded_file' not in st.session_state:
    st.session_state.uploaded_file = None
if 'model' not in st.session_state:
    st.session_state.model = 'EfficientNetAutoAttB4'
if 'dataset' not in st.session_state:
    st.session_state.dataset = 'DFDC'
if 'threshold' not in st.session_state:
    st.session_state.threshold = 0.5
if 'frames' not in st.session_state:
    st.session_state.frames = 50
if 'result' not in st.session_state:
    st.session_state.result = None
if 'pred' not in st.session_state:
    st.session_state.pred = None

# Read HTML file
html_paths = [
    os.path.join(os.path.dirname(__file__), 'frontend.html'),
    'frontend.html',
    'deepfake-detection-main/frontend.html'
]

html_content = None
for path in html_paths:
    try:
        with open(path, 'r', encoding='utf-8') as f:
            html_content = f.read()
            break
    except:
        continue

if html_content is None:
    st.error("Could not load frontend.html")
    st.stop()

# Modify JavaScript to work with Streamlit
# Replace checkForDeepfake to trigger Streamlit processing
modified_html = html_content.replace(
    """function checkForDeepfake() {

            // Show loading page

            document.getElementById('mainPage').classList.add('hidden');

            document.getElementById('loadingPage').classList.remove('hidden');

            

            const messages = [

                'Extracting features and analyzing frames...',

                'Running AI detection models...',

                'Analyzing facial patterns and artifacts...',

                'Computing confidence scores...'

            ];

            

            let messageIndex = 0;

            const messageInterval = setInterval(() => {

                messageIndex = (messageIndex + 1) % messages.length;

                document.getElementById('loadingMessage').textContent = messages[messageIndex];

            }, 2000);

            

            // Simulate API call (replace with actual API call)

            setTimeout(() => {

                clearInterval(messageInterval);

                

                // Simulate result (replace with actual API response)

                const isDeepfake = Math.random() > 0.5;

                const confidence = Math.random() * 0.3 + (isDeepfake ? 0.6 : 0.1);

                

                showResults(isDeepfake, confidence);

            }, 5000);

        }""",
    """function checkForDeepfake() {
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('loadingPage').classList.remove('hidden');
            
            const messages = [
                'Extracting features and analyzing frames...',
                'Running AI detection models...',
                'Analyzing facial patterns and artifacts...',
                'Computing confidence scores...'
            ];
            
            let messageIndex = 0;
            const messageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % messages.length;
                document.getElementById('loadingMessage').textContent = messages[messageIndex];
            }, 2000);
            
            // Trigger Streamlit processing
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'streamlit:setComponentValue',
                    value: { action: 'process' }
                }, '*');
            }
        }"""
)

# Replace showMainPage
modified_html = modified_html.replace(
    """function showMainPage() {

            document.getElementById('heroPage').classList.add('hidden');

            document.getElementById('mainPage').classList.remove('hidden');

            document.getElementById('resultsPage').classList.add('hidden');

            document.getElementById('loadingPage').classList.add('hidden');

        }""",
    """function showMainPage() {
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'streamlit:setComponentValue',
                    value: { action: 'showMain' }
                }, '*');
            }
            document.getElementById('heroPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('resultsPage').classList.add('hidden');
            document.getElementById('loadingPage').classList.add('hidden');
        }"""
)

# Hero Page
if st.session_state.page == 'hero':
    # Show hero page only
    hero_html = modified_html
    hero_html = hero_html.replace('id="mainPage" class="hidden"', 'id="mainPage" class="hidden"')
    hero_html = hero_html.replace('id="resultsPage" class="hidden"', 'id="resultsPage" class="hidden"')
    hero_html = hero_html.replace('id="loadingPage" class="hidden"', 'id="loadingPage" class="hidden"')
    
    components.html(hero_html, height=800, scrolling=False)
    
    # Hidden button to trigger navigation
    if st.button("", key="start_hidden"):
        st.session_state.page = 'main'
        st.rerun()

# Main Page
elif st.session_state.page == 'main':
    # File upload (hidden, will sync with HTML)
    file_types = ["jpg", "jpeg", "png"] if st.session_state.file_type == 'Image' else ["mp4"]
    uploaded_file = st.file_uploader(
        "Upload",
        type=file_types,
        key="file_uploader",
        label_visibility="collapsed"
    )
    
    if uploaded_file is not None:
        st.session_state.uploaded_file = uploaded_file
    
    # Show main page
    main_html = modified_html
    main_html = main_html.replace('id="heroPage" class="gradient-bg min-h-screen', 'id="heroPage" class="hidden gradient-bg min-h-screen')
    main_html = main_html.replace('id="mainPage" class="hidden gradient-bg', 'id="mainPage" class="gradient-bg')
    
    components.html(main_html, height=1200, scrolling=True)
    
    # Advanced Settings (sync with HTML)
    with st.expander("⚙️ Advanced Settings", expanded=False):
        model = st.selectbox(
            "Model",
            ("EfficientNetB4", "EfficientNetB4ST", "EfficientNetAutoAttB4", "EfficientNetAutoAttB4ST"),
            index=2 if st.session_state.model == 'EfficientNetAutoAttB4' else 0,
            key="model_select"
        )
        st.session_state.model = model
        
        dataset = st.radio(
            "Dataset",
            ("DFDC", "FFPP"),
            index=0 if st.session_state.dataset == 'DFDC' else 1,
            key="dataset_radio",
            horizontal=True
        )
        st.session_state.dataset = dataset
        
        threshold = st.slider(
            "Threshold",
            0.0, 1.0, st.session_state.threshold,
            key="threshold_slider",
            step=0.01
        )
        st.session_state.threshold = threshold
        
        if st.session_state.file_type == "Video":
            frames = st.slider(
                "Frames",
                0, 100, st.session_state.frames,
                key="frames_slider"
            )
            st.session_state.frames = frames
    
    # Process button
    if st.button("Check for Deepfake", key="check_btn", type="primary"):
        if st.session_state.uploaded_file is not None:
            st.session_state.page = 'loading'
            st.rerun()

# Loading Page
elif st.session_state.page == 'loading':
    loading_html = modified_html
    loading_html = loading_html.replace('id="heroPage" class="gradient-bg min-h-screen', 'id="heroPage" class="hidden gradient-bg min-h-screen')
    loading_html = loading_html.replace('id="mainPage" class="hidden gradient-bg', 'id="mainPage" class="hidden gradient-bg')
    loading_html = loading_html.replace('id="loadingPage" class="hidden gradient-bg', 'id="loadingPage" class="gradient-bg')
    loading_html = loading_html.replace('id="resultsPage" class="hidden gradient-bg', 'id="resultsPage" class="hidden gradient-bg')
    
    components.html(loading_html, height=800, scrolling=False)
    
    # Process file
    if st.session_state.uploaded_file is not None:
        with st.spinner("Processing..."):
            try:
                if st.session_state.file_type == "Image":
                    result, pred = process_image(
                        image=st.session_state.uploaded_file,
                        model=st.session_state.model,
                        dataset=st.session_state.dataset,
                        threshold=st.session_state.threshold
                    )
                else:
                    os.makedirs("uploads", exist_ok=True)
                    with open(f"uploads/{st.session_state.uploaded_file.name}", "wb") as f:
                        f.write(st.session_state.uploaded_file.read())
                    
                    video_path = f"uploads/{st.session_state.uploaded_file.name}"
                    
                    result, pred = process_video(
                        video_path=video_path,
                        model=st.session_state.model,
                        dataset=st.session_state.dataset,
                        threshold=st.session_state.threshold,
                        frames=st.session_state.frames
                    )
                
                st.session_state.result = result
                st.session_state.pred = pred
                st.session_state.page = 'result'
                st.rerun()
            except Exception as e:
                st.error(f"Error: {str(e)}")
                st.session_state.page = 'main'
                st.rerun()

# Results Page
elif st.session_state.page == 'result':
    result_html = modified_html
    result_html = result_html.replace('id="heroPage" class="gradient-bg min-h-screen', 'id="heroPage" class="hidden gradient-bg min-h-screen')
    result_html = result_html.replace('id="mainPage" class="hidden gradient-bg', 'id="mainPage" class="hidden gradient-bg')
    result_html = result_html.replace('id="loadingPage" class="hidden gradient-bg', 'id="loadingPage" class="hidden gradient-bg')
    result_html = result_html.replace('id="resultsPage" class="hidden gradient-bg', 'id="resultsPage" class="gradient-bg')
    
    # Inject results
    if st.session_state.result is not None and st.session_state.pred is not None:
        is_real = st.session_state.result == 'real'
        confidence = st.session_state.pred
        
        result_script = f"""
        <script>
        (function() {{
            function injectResults() {{
                if (typeof showResults === 'function') {{
                    showResults({str(is_real).lower()}, {confidence});
                }} else {{
                    setTimeout(injectResults, 100);
                }}
            }}
            window.addEventListener('load', injectResults);
            injectResults();
        }})();
        </script>
        """
        result_html = result_html.replace('</body>', result_script + '</body>')
    
    components.html(result_html, height=1000, scrolling=True)
    
    # Action buttons
    col1, col2 = st.columns(2)
    with col1:
        if st.button("← Analyze Another File", key="analyze_another"):
            st.session_state.uploaded_file = None
            st.session_state.result = None
            st.session_state.pred = None
            st.session_state.page = 'main'
            st.rerun()
    with col2:
        if st.button("Download Report", key="download_report", type="primary"):
            st.info("Report download functionality would be implemented here")
